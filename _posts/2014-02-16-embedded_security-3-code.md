---
id: 970
title: Безопасность во встраиваемых системах / код
date: 2014-02-16T22:18:43+00:00
author: catethysis
layout: post
guid: http://catethysis.ru/?p=970
permalink: /embedded_security-3-code/
ratings_users:
  - 1
  - 1
  - 1
ratings_score:
  - 5
  - 5
  - 5
ratings_average:
  - 5
  - 5
  - 5
notely:
  - 
  - 
  - 
wp_noextrenallinks_mask_links:
  - 0
  - 0
  - 0
dsq_thread_id:
  - 2726568651
categories:
  - Электроника
---
Теперь поговорим непосредственно про код. Многое вам даст стандарт MISRA C, однако я хотел бы также дать общие рекомендации. Всё, что здесь написано &#8212; исходит из моего опыта, на что напарывался лично я. Остальное можно прочитать и в MISRA, и у Александреску.

<!--more-->

## Комментарии

То, о чем любая хорошая книжка по основам программирования пишет в первых же главах, и все равно немногие программисты это делают. Особенно часто, к сожалению, это встречается среди эмбеддеров. Однако, вам нужно помнить несколько вещей.

Первое, &#171;хороший код самодокументирован&#187; &#8212; это миф. Никакой код не может ответить на вопрос, зачем он вообще нужен, где и как применяется и какие ограничения содержит. А если в библиотеке рядом лежат две его версии (например, работающие с разным форматом исходных данных) &#8212; то даже вдумчивое чтение кода может дать неполное представление о разнице между версиями. Простой текстовый блок с описанием функции сэкономит много времени и нервов. Тем не менее, понятные и самоописывающие имена переменных и функций &#8212; это хорошая штука.

Второе &#8212; помните, что вы пишете коммерческий код, который будут поддерживать ваши преемники. Вы хотите, чтобы вас заочно поливали грязью? Всегда помните про метрику WTF/минуту.

Третье &#8212; интересный метод разработки нового модуля или программы: сначала в комментарии простым текстом, русским языком описываем все, что программа должна делать. Потом каждое действие расписываем более подробно. После достижения нужного уровня описания начинаем под каждым блоком текста писать код, выполняющий этот блок. Вот что такое настоящий самодокументированный код! <img src="http://catethysis.ru/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" />

**Код должен быть понятным, а не лаконичным.** Все эти экономии строк и прочая фигня будут съедены компилятором и не замечены.

## Костыли / workaround

Обходитесь без костылей. Вы должны понимать, как _оно_ работает.
  
Костыли оставьте программистам на java, они обрадуются. Также я довольно плохо отношусь к полному рефакторингу на любых стадиях, особенно не в начале &#8212; писать нужно сразу грамотно.

## Модульность

Первый признак плохого кода &#8212; один файл main.c. Совершенно точно в вашем коде есть **независимые блоки**, которые можно вытащить в отдельный файл. Первое, что я складываю в stuff.c или main.h &#8212; это всевозможные процедуры инициализации периферии. Править вы их будете нечасто (если вообще будете), а вот глаз они вам намозолят, находясь в главном файле. Вообще, по мере развития программы я создаю файл hal.c (hardware abstraction layer), в который скидываю все функции работы с железом &#8212; при необходимости перехода на другое железо правки понадобятся только этому файлу. Можно создать несколько таких файлов под разное железо, и включать их директивами условной компиляции.

## Константы и define

Тоже довольно распространённый совет. Никогда не создавайте в коде **волшебные значения** &#8212; такие как битрейт связи, адреса портов, IP и MAC-адреса и прочие параметры. Обязательно складывайте их в дефайны с описанием, откуда это значение взялось. Это сэкономит время правки кода (поправить IP-адрес в одном месте в начале файла &#8212; или бегать по всем файлам, и в итоге забыть поменять в паре мест), и облегчит понимание сути этих значений.

Однако, не используйте define там, где без него можно обойтись. Код библиотеки NanoPB &#8212; пример переизбытка дефайнов, эти парни половину всей логики сделали на макросах. Разбираться и ремонтировать эту библиотеку не слишком удобно, особенно с обрезанным препроцессором, не генерирующим .i-файл.

## Сторонний код

Ни строчки кода в продакшн без понимания сути. Взяли код из книжки, а тем более скопипастили из интернета &#8212; всё в топку и **переписывать**. Названия книжек, адреса сайтов, великие имена великих писателей этого гениального кода &#8212; ничто не может быть оправданием перед непониманием алгоритма работы этого кода. А если там ошибка &#8212; на кого вы будете сваливать ответственность?

Я не говорю про известные, проверенные годами библиотеки &#8212; их переписывать довольно дорого и глупо. Но знать, _что_ и _как_ они делают &#8212; нужно обязательно. Тем более в эмбеде не нужны всякие монструозные библиотеки вроде Flash и подобных.

## Инициализация переменных

Всегда инициализируйте свои переменные, даже те что лежат не в основной памяти. Комично выглядит ситуация, когда сразу после прошивки девайса и до подключения его к внешним системам он внезапно выдаёт ненулевые значения каких-то индицируемых параметров.