---
id: 1903
title: Метеостанция с историей
date: 2014-07-29T13:03:34+00:00
author: Catethysis
layout: post
guid: http://catethysis.ru/?p=1903
permalink: /stm32_nodejs_meteostation_with_mysql_log/
ratings_users:
  - 3
ratings_score:
  - 15
ratings_average:
  - 5
wp_noextrenallinks_mask_links:
  - 0
dsq_thread_id:
  - 2923203819
categories:
  - Готовые девайсы
tags:
  - nodejs
  - STM32
  - датчики
  - метеостанция
  - погода
  - электроника
---
Всем привет! Уверен что вы по мне скучали — теперь я продолжу радовать вас ежедневными обновлениями.
  
Небольшое дополнение к недавней статье [&#171;Домашняя метеостанция&#187;](http://catethysis.ru/home-meteostation-stm32/ "Домашняя метеостанция на STM32 и Node.js").
  
Мне интересно видеть не только текущие данные, но и историю изменения их во времени — добавим к веб-странице график.

[<img class="alignnone size-full wp-image-1907" src="http://catethysis.ru/wp-content/uploads/2014/07/meteo1.png" alt="meteo" width="593" height="307" />](http://catethysis.ru/wp-content/uploads/2014/07/meteo1.png)

&nbsp;

<!--more-->

## Хранение данных

Используем базу данных MySQL с простейшей таблицей — ID, дата/время, температура в квартире, температура на улице, давление и влажность. Подключимся к ней из Node.js через модуль [node-mysql](http://catethysis.ru/mysql-node-js/ "Работа с MySQL в Node.js"), и при каждом опросе датчиков просто будем записывать новые данные с помощью такого кода:

<pre><code class="javascript">setInterval(function() {connection.query('insert into meteo values (NULL, DEFAULT, '+thermo[0]+', '+thermo[1]+', '+thermo[2]+', 0);', function(){}); }, 60000);</code></pre>

То есть, каждую минуту складываем в базу новую запись с последними данными с датчиков.
  
Для получения последних N записей — используем запрос

<pre><code class="sql">select * from meteo order by id desc limit 30;</code></pre>

_limit 30_ ограничивает вывод 30 записями, а благодаря сортировке _order by id DESC_ эти 30 записей отсчитываются с конца.

## График

Используем библиотеку jquery.flot &#8212; она довольно удобна, красивый график можно сделать написав совсем немного кода.
  
Всё что вам нужно &#8212; подключить библиотеки jQuery и flot, разместить на странице div под график (не забудьте настроить его размеры), и выполнить такую строчку:

<pre><code class="javascript">$.plot($("#placeholder"), [t1, t2], { xaxis: { mode: "time", timeformat: "%H:%M" }, yaxis: { tickDecimals: 1, labelWidth: 20 } });</code></pre>

В принципе, всё ясно из кода &#8212; но всё же немножко прокомментирую.
  
функция plot строит на выбранном div (который указывается первым параметром) графики наборов данных из второго параметра. На одном графике может быть несколько серий данных, и второй параметр устроен таким образом:

<pre><code class="javascript">[
    [
        [x1_1, y1_1],
        [x1_2, y1_2],
        ...
        [x1_N, y1_N]
    ],
    [
        [x2_1, y2_1],
        [x2_2, y2_2],
        ...
        [x2_N, y2_N]
    ],
    [
        [x3_1, y3_1],
        [x3_2, y3_2],
        ...
        [x3_N, y3_N]
    ],
    ...
]</code></pre>

Если нужно отобразить только один набор данных &#8212; передайте функции массив [[[x1, y1], [x2, y2], &#8230; ]].

Третий аргумент &#8212; параметры графика. Можно настроить как общие параметры (название, содержание и размещение легенды) так и параметры осей (тип, формат отметок и значений, цвет и минимум/максимум, ширину поля значений). По умолчанию оси автоматически подстроятся под данные.

## Обновление

Теперь нужно только периодически опрашивать сервер, забирая с него новые данные. Чтобы не обновлять страницу &#8212; воспользуемся технологией AJAX с помощью библиотеки jQuery. Сервер будет предоставлять два REST API интерфейса:

  * /thermo/new &#8212; для получения текущих показаний. Это просто JSON-объект со значениями температур и давления.
  * /thermo/log &#8212; для выгрузки истории показаний. Сервер отдаёт JSON-массив с показаниями и датой/временем каждого отчёта.

На клиенте установим два таймера: раз в секунду будем забирать новые показания и раз в 30 секунд &#8212; историю. Принятые данные будем отображать на панели текущих значений и на графиках.

## Сглаживание

При выводе всех отчётов на график он становится довольно неряшливым и шумным. Простое решение &#8212; на сервере брать из базы только каждое десятое или сотое значение, а на клиенте &#8212; сгладить график, чтобы при меньшем числе точек он не стал угловатым.

Для сглаживания я использую плагин <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://curvedlines.michaelzinsmaier.de/" >CurvedLines</a> для библиотеки Flot. Для получения каждого сотого значения из базы &#8212; добавляю в SQL-запрос условие &#171;WHERE ID % 100 = 0&#8243;, весь запрос теперь выглядит так:

<pre><code class="sql">select * from meteo where id%100 = 0 order by id desc limit 30;</code></pre>

То есть, запрос будет вытаскивать из базы каждую сотую запись с конца, и прекратит это делать лишь набрав 30 записей.

Итоговый результат можно смотреть на странице <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://thermo.catethysis.ru/" >моей домашней метеостанции</a>.