---
id: 235
title: Тег-ориентированная файловая система — интерфейс
date: 2013-09-20T08:23:31+00:00
author: catethysis
layout: post
guid: http://catethysis.ru/?p=235
permalink: /tagged-fs-3/
ratings_users:
  - 1
  - 1
  - 1
ratings_score:
  - 5
  - 5
  - 5
ratings_average:
  - 5
  - 5
  - 5
wp_noextrenallinks_mask_links:
  - 0
dsq_thread_id:
  - 2780374360
categories:
  - Программирование
tags:
  - теговая фс
---
[Вступление
  
Архитектура](http://catethysis.ru/?p=230 "Тег-ориентированная файловая система — архитектура")

API устроен следующим образом.

### Запрос картинки

**Вход:** GUID картинки.
  
**Процесс:** из таблицы PhotoTags получаем перечень записей, относящихся к искомой фотографии &#8212; это номера тегов. Inner join\`ом превращаем их в названия тегов.
  
**Выход:** дата фотографии, список номеров тегов с названиями тегов.

### Запрос архива фотографий

**Вход:** номер тега, или null для получения полного архива.
  
**Процесс:** проходим по таблице PhotoTags, ищем все записи с искомым тегом (или вообще все записи если тег не указан). Группируем по GUID, т.е. получаем напротив каждого GUID список номеров тегов. Из таблицы тегов получаем их названия.
  
**Выход:** список GUID\`ов, у каждого GUID &#8212; список номеров и названий тегов.

### Запрос списка тегов

**Вход:** &#8212;
  
**Процесс:** проходим по таблице PhotoTags, группируем записи по номерам тегов, считаем размер каждой группы и упорядочиваем список по убыванию.
  
**Выход:** список номеров, названий тегов и их популярности, упорядоченный по убыванию популярности.

### Добавление фотографии

**Вход:**  временный адрес фотографии в папке загрузок
  
**Процесс:** генерируем GUID, копируем фотографию в нашу папку (с именем GUID), генерируем два размера картинок (с шириной 1620 пкс и 160 пкс), читаем EXIF-тег времени съёмки. В таблицу фотографий добавляем запись: GUID, время съёмки.
  
**Выход:** GUID.

### Добавление тегов

**Вход:**  GUID, список тегов
  
**Процесс:** из таблицы тегов берём все их названия, ищем отрицание пересечения двух массивов. Новые теги, не существующие пока в таблице &#8212; добавляем в неё. Снова получаем массив тегов из таблицы, ищем в нём номера введённых тегов, и добавляем в базу PhotoTags записи: GUID, id_тега.
  
**Выход:** -