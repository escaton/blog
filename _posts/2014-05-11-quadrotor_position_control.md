---
id: 1405
title: Управление положением квадрокоптера
date: 2014-05-11T13:34:50+00:00
author: catethysis
layout: post
guid: http://catethysis.ru/?p=1405
permalink: /quadrotor_position_control/
wp_noextrenallinks_mask_links:
  - 0
  - 0
  - 0
ratings_users:
  - 1
  - 1
  - 1
ratings_score:
  - 5
  - 5
  - 5
ratings_average:
  - 5
  - 5
  - 5
dsq_thread_id:
  - 2726610162
categories:
  - Квадрокоптер
tags:
  - квадрокоптер
  - электроника
---
С точки зрения кинематики квадрокоптер представляет из себя 4 пропеллера, расположенных по углам квадрата, тяга которых направлена вниз. Самое главное: в отличие от вертолётов и самолётов он статически неустойчив в воздухе, и не может просто висеть без управления им &#8212; сразу же где-нибудь возникает перекос и коптер падает.

Теоретическая механика говорит нам, что положение твёрдого тела в пространстве задаётся шестью координатами (степенями свободы) &#8212; 3 поступательных и 3 вращательных. В авиации под координатами вращения понимаются углы Эйлера, и они обозначаются как крен (roll, поворот вокруг оси X), тангаж (pitch, поворот вокруг Y) и рысканье (yaw, поворот вокруг Z).

Коптер может управлять своим вращением только с помощью тяги винтов. Поэтому в первую очередь нужно рассмотреть управление тягой.

<!--more-->

## Управление тягой винта

Для управления скоростью мотора у регулятора есть вход ШИМ-сигнала. Точнее говоря, этот сигнал выглядит как ШИМ, но важна лишь длительность &#171;1&#187; в нём. Период повторения находится в пределах 10-20мс, и не очень важен &#8212; разве что маленький период позволит чаще менять скорость и делает систему управления более отзывчивой. На самом деле, такой сигнал скорее будет называться PDM (Pulse Density Modulation), но создавать мы его будем ШИМ-модулем микроконтроллера.

<img class="alignnone" src="http://static.catethysis.ru/files/copter_pwm_signal.png" alt="" width="1228" height="690" />

Генерировать такой сигнал очень удобно, используя практически любой из таймеров STM32 (кроме базовых). Каждый таймер STM32 имеет по 4 порта ввода-вывода, которые в [режиме ШИМ](http://catethysis.ru/stm32-%e2%86%92-%d1%82%d0%b0%d0%b9%d0%bc%d0%b5%d1%80%d1%8b-%e2%86%92-%d1%88%d0%b8%d0%bc/ "STM32 → таймеры → ШИМ") включаются на &#171;выход&#187;; они имеют общий период повторения, но разную скважность. То есть, настраиваем один из таймеров (я использую TIM3) на ШИМ, назначаем ножки (в STM32F3 очень удобная система перенаправления этих ножек, доступны по два-три варианта для каждого комплекта), устанавливаем общий период, и нам остаётся лишь обновлять значения скважностей в разных каналах.

Скорость мотора будет примерно пропорциональной длительности &#171;1&#187;: 0% при 0.5мс и 100% при 2.4мс. Эти значения крайне примерные, обязательно нужно проверить их на живом моторе и ESC.

Зависимость тяги пропеллера от поданного сигнала нелинейна по нескольким причинам:

  1. неизвестна программа ESC &#8212; должна быть линейная зависимость скорости от сигнала, но это тяжело проверить.
  2. пропеллер имеет приблизительно квадратичную зависимость тяги от скорости вращения.
  3. при большой нагрузке проседает напряжение батареи, и на всех проводах тоже теряется бОльшее напряжение.

Я думаю, что можно примерно оценивать зависимость &#171;сигнал-тяга&#187; как квадратичную.

Комплекс &#171;контроллер+мотор+пропеллер&#187; обычно называется винтомоторной группой (ВМГ) &#8212; потому что для наших нужд нет смысла рассматривать эти детали в отдельности, и ВМГ для нас это просто чёрный ящик со входом &#171;газ&#187;.

## Управление наклоном (крен и тангаж)

Чтобы наклонить коптер в какую-то сторону &#8212; нужно ослабить тягу винтов на этой стороне, но так уменьшится общая тяга, и нужно это скомпенсировать увеличив тягу противоположных винтов.

Очень удобно представить желаемый наклон как вектор (нормаль к плоскости требуемого положения коптера), и рассматривать проекции этого вектора на лучи коптера. Тяга каждого мотора должна быть пропорциональна этим проекциям.

<img class="alignnone" src="http://static.catethysis.ru/files/copter_angle_theory.png" alt="" width="1228" height="690" />

Требуемый наклон направлен в сторону 1 и 2 моторов: 30 градусов к 1 и 60 градусов ко 2. Значит, на 1 мотор пойдёт +0.7 тяги, на второй &#8212; +0.5, на третий &#8212; -0.7, на чевёртый &#8212; -0.5. Проекции R3 и R4 имеют отрицательную длину. Удобнее разобраться на виде снизу:

<img class="alignnone" src="http://static.catethysis.ru/files/copter_angle_theory_proj.png" alt="" width="1228" height="690" />

При такой точке зрения на управление становится неважным количество моторов &#8212; этот метод одинаково подойдёт и для лёгкого трикоптера, и для тяжелого двойного октокоптера, поменяется только число проекций вектора управления.

## Управление поворотом (рысканье)

Если использовать одинаковые пропеллеры, вращающиеся в одну сторону &#8212; сам аппарат будет закручиваться в горизонтальной плоскости в противоположном направлении. Чтобы устранить этот эффект &#8212; используют два &#171;правых&#187; пропеллера и два &#171;левых&#187;, и вращают их в разные стороны. Таким образом, они будут взаимно компенсировать рысканье аппарата. Если же нарушить этот баланс &#8212; коптер начнёт поворачиваться в какую-то сторону (по закону сохранения момента импульса). То есть, чтобы изменить рысканье коптера &#8212; нужно замедлить одну диагональную пару винтов, и ускорить другую пару, в зависимости от требуемого знака рысканья и направлений вращения винтов. К примеру, чтобы повернуть направо &#8212; нужно ускорить &#171;левые&#187; винты и замедлить &#171;правые&#187;.

Все методы управления положением используют отклонение скоростей моторов от некой средней скорости, поэтому в следующих статьях я буду говорить о &#171;скорости&#187; как об отклонении скорости мотора относительно средней.

**Статьи цикла:
  
** 1. [Начинаем проект квадрокоптера](http://catethysis.ru/quadrocopter_intro/ "Начинаем проект квадрокоптера")
  
2. [Выбор деталей](http://catethysis.ru/multicopter_parts_choose/ "Выбор деталей квадрокоптера")
  
3. [Заказ деталей на Hobbyking.com](http://catethysis.ru/multicopter_parts_order_hobbyking/ "Заказ деталей для квадрокоптера на Hobbyking.com")
  
4. Управление положением квадрокоптера
  
5. [Получение данных с MEMS-акселерометра](http://catethysis.ru/%d0%b8%d0%bd%d0%b5%d1%80%d1%86%d0%b8%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b9-%d0%b4%d0%b0%d1%82%d1%87%d0%b8%d0%ba-%d1%81-usb-%d0%b8%d0%bd%d1%82%d0%b5%d1%80%d1%84%d0%b5%d0%b9%d1%81%d0%be%d0%bc/ "Инерциальный датчик с USB–интерфейсом")
  
6. [Калибровка и обработка сигнала MEMS-акселерометра](http://catethysis.ru/mems_accelerometer_calibrating/)