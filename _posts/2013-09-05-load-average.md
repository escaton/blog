---
id: 80
title: load average и что с ним делать
date: 2013-09-05T23:56:29+00:00
author: catethysis
layout: post
guid: http://192.168.1.10/?p=80
permalink: /load-average/
ratings_users:
  - 1
  - 1
  - 1
ratings_score:
  - 5
  - 5
  - 5
ratings_average:
  - 5
  - 5
  - 5
wp_noextrenallinks_mask_links:
  - 0
dsq_thread_id:
  - 2737259873
categories:
  - Linux
tags:
  - linux
  - сервер
---
Сервер раздаёт несколько торрентов с помощью transmission, также на сервере настроена Samba. Включаем просмотр видео из samba-папки с помощью xbmc на другом компьютере.
  
Параллельно с этим, начинаем раздавать на третьем компьютере торренты из этой samba-папки (суммарная скорость раздачи всех торрентов на всех компах &#8212; 3 МБ/с). Сразу же воспроизведение видео прекращается. Проблема!

<!--more-->

Первое, что нужно проверить &#8212; это <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://en.wikipedia.org/wiki/Load_(computing)" >load average</a>. Смотреть его можно командами uptime или w . Для оценки загруженности достаточно первого параметра &#8212; он сообщает, сколько процессов находится в очереди к процессору. В первом приближении, эта цифра должна быть не больше количества ядер процессора (т.е. один процесс на каждое ядро). Это не жёсткое правило, но на него стоит обратить внимание.

Далее, можно узнать более подробную информацию командой top. Она покажет список процессов, занятую память и прочее, а также статистику по задачам процессов (3 строчка):

<pre>%Cpu(s): 0,0 us, 4,3 sy, 0,0 ni, 64,5 id, 31,2 wa, 0,0 hi, 0,0 si, 0,0 st</pre>

Здесь подробно расписано, на что процессор тратит время. Что означает каждый пункт?

us &#8212; user &#8212; пользовательские процессы (с исходным приоритетом);
  
sy &#8212; system &#8212; системные (ядерные) процессы;
  
ni &#8212; nice &#8212; процессы с изменённым приоритетом;
  
id &#8212; idle &#8212; бездействие;
  
wa &#8212; I/O_wait &#8212; ожидание ввода-вывода;
  
hi &#8212; hardware interrupt &#8212; обработка аппаратных прерываний (сообщения от мыши, от других устройств);
  
si &#8212; software interrupt &#8212; обработка программных прерываний (интерфейсы BIOS, системные вызовы);
  
st &#8212; steal &#8212; для виртуальных машин, означает &#171;время, украденное хостом у виртуалки&#187;.

_<a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://en.wikipedia.org/wiki/Nice_(Unix)"  target="_blank">nice</a> &#8212; дословно, &#171;учтивость&#187; перед другими процессами. Чем она выше, тем более учтиво процесс относится к другим, отдаёт им больше времени, и тем ниже его приоритет. Ещё раз: выше nice &#8212; ниже приоритет, и наоборот._

Можно залезть ещё глубже, разбив статистику по ядрам процессора нажатием клавиши &#171;1&#187;.

<pre>%Cpu0 : 0,0 us, 6,4 sy, 0,0 ni, 0,0 id, 91,5 wa, 0,0 hi, 2,1 si, 0,0 st
%Cpu1 : 0,0 us, 0,0 sy, 0,0 ni,100,0 id, 0,0 wa, 0,0 hi, 0,0 si, 0,0 st
%Cpu2 : 0,0 us, 1,0 sy, 0,0 ni, 96,1 id, 2,9 wa, 0,0 hi, 0,0 si, 0,0 st
%Cpu3 : 1,0 us, 1,9 sy, 0,0 ni, 97,1 id, 0,0 wa, 0,0 hi, 0,0 si, 0,0 st</pre>

О чём говорят высокие показатели (конечно, кроме id = idle)?

<p style="padding-left: 30px;">
  <strong>us+sy>70:</strong> именно эти значения отражают реальную вычислительную работу процессора, так что если они высоки &#8212; нужно менять процессор на более мощный.
</p>

<p style="padding-left: 30px;">
  <strong>wa>30:</strong> дисковая подсистема не справляется с нагрузкой. Возможно несколько вариантов:<span style="line-height: 1.5;"><br /> </span>
</p>

  * жёсткий диск близок к смерти, либо можно попробовать использовать SSD.
  * слишком частый сброс большого объёма данных в своп &#8212; нужно увеличить оперативку.
  * какой-то процесс очень часто пишет что-то в лог.

<p style="padding-left: 30px;">
  Дальше нужно решать проблему с помощью iotop/iostat.
</p>

<p style="padding-left: 30px;">
  <strong>st>10</strong> (на виртуальной машине): <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://habrahabr.ru/post/71020/#comment_2031828"  target="_blank">нужно переходить</a> на более высокий тарифный план хостера.
</p>

_Можно увеличить скорость обновления таблицы top: нажать d 1 [Enter] Shift-W._
  
 _В немного более красивом виде информацию предоставляет утилита htop (sudo apt-get htop), а ещё в ней можно менять приоритет (nice) процессов._

Важное замечание: иногда некоторые процессы linux переходят в состояние зомби &#8212; они завершили свою работу, но не уведомили об этом операционную систему. Тем самым они остались в таблице процессов, и занимают место. Их невозможно убить ничем кроме как рестартом системы (неожиданная вещь для линукса, правда?). Их количество отображает утилита top.

<span style="line-height: 1.5;">В моём случае, я узнал что проблема в диске. Торрент-клиенты эксплуатируют диск в рваном режиме: крайне непоследовательное чтение коротких кусков файлов. А ведь раздача идёт на скорости 3 МБайт/с, и видимо это предел для диска в режиме случайного чтения.<br /> Как решение именно дисковой проблемы, можно создать виртуальный диск в памяти, но в любом случае его объёма не хватит для торрентов.<br /> Поэтому лучше сделать так: уменьшить приоритет торрент-качалки до низких значений, а приоритет самбы поднять. Правда, у меня есть ещё и торрент-качалка, раздающая с самба-директории &#8212; но значит, не судьба.</span>

<a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://habrahabr.ru/post/146983/" >Источник</a>