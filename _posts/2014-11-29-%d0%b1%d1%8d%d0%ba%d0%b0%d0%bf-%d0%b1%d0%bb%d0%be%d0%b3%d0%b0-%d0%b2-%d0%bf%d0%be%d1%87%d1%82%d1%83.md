---
id: 2110
title: Бэкап блога в почту
date: 2014-11-29T14:02:28+00:00
author: Catethysis
layout: post
guid: http://catethysis.ru/?p=2110
permalink: /%d0%b1%d1%8d%d0%ba%d0%b0%d0%bf-%d0%b1%d0%bb%d0%be%d0%b3%d0%b0-%d0%b2-%d0%bf%d0%be%d1%87%d1%82%d1%83/
ratings_users:
  - 1
ratings_score:
  - 5
ratings_average:
  - 5
wp_noextrenallinks_mask_links:
  - 0
dsq_thread_id:
  - 3273864416
categories:
  - Linux
  - Сервер
---
Очередная короткая заметка по текущим делам: сделал автоматический ежедневный бекап всей базы блога в почту.

Для получения архива базы блога воспользуемся утилитой mysqldump. Она принимает параметры:

<pre>-u <em>имя_юзера</em> -p<em>пароль</em> <em>название_базы</em></pre>

Обратите внимание, пароль пишется без пробела сразу после -p. Название базы вордпресса &#8212; &#171;wordpress&#187;, если вы его не меняли при установке. После выполнения этой команды в stdout прилетит весь архив. Мы сразу завернём его пайпом в упаковщик gzip:

<!--more-->

<pre>mysqldump -u user -ppassword wordpress | gzip</pre>

А результат его работы &#8212; в файл с именем, содержащим сегодняшнюю дату:

<pre>mysqldump -u user -ppassword wordpress | gzip &gt; `date +/root/blog.%Y%m%d.gz`</pre>

Эта магия работает так: утилита date рассматривает параметр после &#171;+&#187; как форматную строку, примерно как функция printf в си. Литералы %Y, %m и %d соответственно заменяются на год, месяц и дату, а остальные символы остаются без изменений. Вся полученная строка отдаётся в stdout, но команда завёрнута в обратные кавычки &#8212; поэтому результат её работы передаётся в команду &#171;gzip > &#8230;&#187;, что заставляет shell записать вывод команды gzip в указанный файл.

Теперь измерим размер этого файла:

<pre>du `date +/root/blog.%Y%m%d.gz` -BK | cut -f1</pre>

du сообщает размер выбранного файла, а параметр -BK переводит размер в килобайты. Результат работы команды &#8212; таблица с полями &#171;размер&#187; и &#171;имя файла&#187;, поэтому вырежем первую колонку командой cut с параметром -f1.

Вот уже в двух местах использовано одинаковое имя файла, поэтому стоит перейти на shell-скрипты.

<pre>#!/bin/bash
file=`date +/root/blog.%Y%m%d.gz`
mysqldump -u user -ppassword wordpress | gzip &gt; $file
size="Размер архива: "`du $file -BK | cut -f1`" байт"
echo $size</pre>

Ну и наконец, последний шаг &#8212; отправка всего архива по email. Используем утилиту mutt, которая является фронтендом к Sendmail и умеет отправлять письма со вложениями. Установим её:

<pre>sudo apt-get install mutt</pre>

Очень легко использовать:

<pre>echo "Текст письма" | mutt -s "Тема письма" catethysis@catethysis.ru -a blog.20141128.gz</pre>

Параметр -s это тема письма, параметр -a это вложенный файл. Без параметра передаётся адрес получателя, а текст забирается из stdin.

**Итоговый скрипт** выглядит так:

<pre>#!/bin/bash
file=`date +/root/blog.%Y%m%d.gz`
mysqldump -u user -ppassword wordpress | gzip &gt; $file
size="Размер архива: "`du $file -BK | cut -f1`" байт"
echo $size | mutt -s "Бэкап блога" catethysis@catethysis.ru -a $file</pre>

Последнее что нужно сделать &#8212; назначить задание для cron:

<pre>crontab -e</pre>

Если спросит &#8212; выбирайте nano, это самый простой редактор из предложенных. Он даже отмечен указателем &#171;<=== easiest&#187; <img src="http://catethysis.ru/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" />

Принцип назначения заданий очень прост, по колонкам:

  1. минуты
  2. часы
  3. день месяца
  4. месяц
  5. день недели

Значение \* означает &#171;любой&#187;. Таким образом, для ежедневного выполнения задания в определённое время нужно написать такое расписание: &#171;0 6 \* \* \*&#187;: любой день месяца и недели, любой месяц, но так чтобы минуты равнялись 0, а часы &#8212; 6. Это соответствует 06:00 каждого дня. Не забудьте про временные зоны! Мой сервер находится в Амстердаме, там действует Центральноевропейское время. 6 утра в Москве превращаются в 4 утра. Хотя можно и переставить часовой пояс.

<pre>0 6 * * * ./blog_backup_pack_send.sh</pre>

Укажите там имя файла вашего скрипта.