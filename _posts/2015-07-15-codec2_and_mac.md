---
id: 2351
title: Голосовой кодек codec2 и его установка на Mac
date: 2015-07-15T03:03:19+00:00
author: Catethysis
layout: post
guid: http://catethysis.ru/?p=2351
permalink: /codec2_and_mac/
ratings_users:
  - 1
ratings_score:
  - 5
ratings_average:
  - 5
wp_noextrenallinks_mask_links:
  - 0
dsq_thread_id:
  - 3935450187
categories:
  - Без рубрики
  - Разное
tags:
  - codec2
  - аудио
  - кодек
---
Меня тут заинтересовала задачка о передаче голоса по радио, да не просто так, а на bleeding edge современных технологий.

Как вы думаете, насколько сильно можно сжать аудиопоток с речью, не очень потеряв в качестве? 64 кбит/с, как в стандарте для телефонной связи? 32 кбит/с, реальный минимум для mp3? Окей, может быть 13 кбит/с, как в GSM?

Кодек <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://www.rowetel.com/blog/?page_id=452" >codec2</a> даёт возможность сжать голос до умопомрачительных 1.2 кбит/с, причём вы можете даже практически не заметить разницы, особенно в шумном окружении. И это не всё, есть ещё и тариф для настоящих скупердяев с битрейтом 700 БИТ В СЕКУНДУ!

<!--more-->

Этот кодек разработан тем же парнем, который в своё время участвовал в создании <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://www.speex.org" >Speex</a> (который так любит ST), из которого потом вырос <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://opus-codec.org" >Opus</a>. Спору нет, оба эти кодека прекрасны, и давно пробрались в энтерпрайз и даже в американскую военку. Но теперь Дэвид Роуи захотел сделать ещё более мощный кодек, и самое главное &#8212; он (естественно) опенсорсный и полностью свободен от патентных ограничений.

К слову, о военке &#8212; у НАТО есть голосовой кодек <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://www.compandent.com/products_melpe.htm" >MELPe</a> для тактических применений, который достигает битрейта 600 бит/с, и на него давно текут слюнки у многих инженеров. Но нет, он конечно же полностью проприетарен, в открытом доступе есть только описание стандарта MELPe 2400 бит/с, который уже не так интересен. Получается, появление codec2 полностью закрывает эту проблему.

Давайте скачаем его и проверим. На сайте есть руководство по его сборке на *nix, но там есть одна небольшая ошибка, а ещё мне надо было собирать его под Mac, поэтому читайте тут.

## Установка codec2 в OSX

Первым делом, нам потребуется сборщик cmake. Скачайте его <a target="_blank" rel="nofollow" href="http://catethysis.ru/goto/http://www.cmake.org/files/v3.3/cmake-3.3.0-rc3-Darwin-x86_64.dmg" >dmg-образ</a> (последняя версия на момент написания &#8212; 3.3.0rc3), установите и перетащите в папку Applications. Теперь надо ещё прописать его в PATH, чтобы можно было использовать его из командной строки &#8212; выполните в терминале команду

<pre>sudo "/Volumes/cmake-3.3.0-rc3-Darwin-x86_64/CMake.app/Contents/bin/cmake-gui" --install</pre>

Посмотреть её можно в меню запущенного gui cmake: Tools -> How to Install for Command Line Use.
  
Теперь скачиваем и собираем codec2.

<pre>svn co https://svn.code.sf.net/p/freetel/code/codec2 codec2
cd codec2
mkdir build_linux
cd build_linux
cmake ../
make
cd src</pre>

В примерах есть несколько файлов с записью голоса. Попробуем сжать один из файлов:

<pre>./c2enc 1200 ../../raw/hts1a.raw hts1a.c2</pre>

Размер сжатой записи составил 450 байт. Разожмём обратно:

<pre>./c2dec 1200 hts1a.c2 hts1a_c2.raw</pre>

Получился файл с сырыми аудиоданными в формате 16-битных знаковых целых и частотой дискретизации 8000 Гц. В OSX нет встроенных средств для прослушивания сырого аудио, и чтобы послушать его &#8212; можно импортировать файл в Audacity, а лучше установим аудиопроцессор sox:

<pre>brew install sox</pre>

И можно слушать результат:

<pre>cat hts1a_c2.raw | sox -traw -r8000 -b16 -e signed-integer - -tcoreaudio</pre>

По-моему, отлично. Битрейт сжатых данных составляет ровно 1200 бит/с, как и было заказано.

Но интереснее же попробовать на реальных примерах! Я записал пару секунд своего голоса, и прогнал их через кодек на максимальном сжатии. Получился битрейт около 1300 бит/с, но есть одна проблема. Похоже, кодек в тестовой программе не различает тишину (как такое вообще может быть?), и можно отчётливо слышать в самом начале, до начала голоса, какие-то помехи. Понятно, что место в файле они тоже занимают.

В следующей статье попробуем его более углублённо, напишем собственную программу &#8212; тест кодека.

## Устройство кодека

Немного о том, как же добиваются таких нереальных степеней сжатия. Три основных метода:

  1. Речь занимает довольно узкую полосу частот, а значит можно обрезать весь спектр только до этого диапазона. В телефонии обычно используют полосу 300..3400Гц, и её хватает для сохранения чёткости и разборчивости голоса.
  2. Опять же, речь довольно хорошо описывается некоторыми упрощёнными формулами, например кодек codec2 использует аппроксимация голоса набором синусоид &#8212; гармоник некой базовой частоты голоса. Хватает очень ограниченного набора частот, чтобы представить речь достаточно точно.
  3. Полученные данные описываются методом кодирования с линейным предсказанием (LPC), который даёт возможность свести индивидуальные особенности голоса человека к небольшому набору коэффициентов, буквально описывающих его речевой аппарат.

Блок-схема внутренностей кодека:

[<img class="alignnone size-full wp-image-2356" src="http://catethysis.ru/wp-content/uploads/2015/07/enc_2550.png" alt="enc_2550" width="588" height="573" />](http://catethysis.ru/wp-content/uploads/2015/07/enc_2550.png)

Вообще, подобные специализированные голосовые кодеки называются вокодерами, потому что они очень заточены именно под передачу голоса. На других источниках звука они работают похуже.

## Потоковое кодирование и передача

Codec2 &#8212; это потоковый кодек, который работает с отдельными наборами семплов звука по 40мс. Он даёт возможность сжимать речь он-лайн, передавать её (например, по радиоканалу) и тут же раскодировать её на приёмнике, значительно экономя пропускную способность канала, ценой лишь несущественной задержки.

Кстати, Дэвид сделал ещё и софт-модем, работающий с codec2. С модуляцией QPSK полоса пропускания такого канала связи составляет всего 1.3кГц.

Всё это даёт нам возможность создания цифровой рации на доступных и недорогих компонентах, которая тем не менее будет иметь хорошие параметры. Подробнее &#8212; в следующих статьях <img src="http://catethysis.ru/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" />